name: Backend Build&Deploy Docker Image w/ largeserver

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-docker-image-and-push:
    name: Build and Push to Docker Hub
    # runs-on: ubuntu-latest
    runs-on: [self-hosted, largeserver]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # QEMU ì„¤ì • (ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ ì—ë®¬ë ˆì´ì…˜)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Docker Buildx ë¹Œë” ì„¤ì •
      # multi-archë¥¼ ì§€ì›í•˜ëŠ” ë“œë¼ì´ë²„ë¡œ ìë™ ì „í™˜
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ìœ„ì—ì„œ ì‘ì„±í•œ Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  íƒœê¹…í•˜ì—¬ í‘¸ì‹œí•©ë‹ˆë‹¤.
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{secrets.DOCKER_BUILD_CONTEXT_PATH}} # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ
          file: ${{secrets.DOCKER_DOCKERFILE_PATH}} # Dockerfile path
          push: true # ë¹Œë“œ í›„ í‘¸ì‹œ ì‹¤í–‰
          tags: ${{secrets.DOCKER_IMAGE_NAME_WITH_TAG}} # versionì€ latestë¡œ ìš°ì„  ê³ ì •
          platforms: linux/amd64,linux/arm64

  docker-pull-and-run:
    name: Pull Latest Docker Image and Run on Home Server
    needs: build-docker-image-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH ì ‘ì† ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USERNAME }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            echo "[1] dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."
            if which docker > /dev/null 2>&1; then
              echo "âœ… dockerê°€ ì •ìƒì ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤: $(which docker)"
            else
              echo "âŒ dockerë¥¼ PATHì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. PATHë¥¼ ë“±ë¡í•©ë‹ˆë‹¤."
              export PATH="$PATH:/usr/local/bin"
              if which docker > /dev/null 2>&1; then
                echo "âœ… PATH ë“±ë¡ í›„ docker ì¸ì‹ë¨: $(which docker)"
              else
                echo "âŒ ì—¬ì „íˆ dockerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ ë˜ëŠ” ì„¤ì¹˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”."
                exit 1
              fi
            fi

            echo "=============================="
            echo "ğŸ“¦ ìµœì‹  Docker ì´ë¯¸ì§€ Pull ì‹œì‘"
            echo "=============================="

            docker pull ${{secrets.DOCKER_IMAGE_NAME_WITH_TAG}}

            echo "âœ… Docker ì´ë¯¸ì§€ Pull ì™„ë£Œ"

            echo "=============================="
            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì‹œì‘"
            echo "=============================="
            docker stop ${{secrets.SERVER_DOCKER_CONATINER_NAME}} || true
            docker rm ${{secrets.SERVER_DOCKER_CONATINER_NAME}} || true
            echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ"

            echo "=============================="
            echo "ğŸ’ª env íŒŒì¼ pathë¡œ ì´ë™"
            echo "=============================="
            echo "ğŸ«¶ ì´ë™ ì „ ë””ë ‰í† ë¦¬: $(pwd)"
            cd ${{ secrets.SERVER_APP_DIRECTORY }}
            echo "âœ… í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"

            echo "ğŸ’ª Creating .env files"
            echo "${{ secrets.DOTENV_DEFAULT }}" | awk 'NF' >> .env
            echo "âœ… .env files created"

            echo "=============================="
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œì‘"
            echo "=============================="
            docker run \
              -d \
              -p ${{secrets.SERVER_APP_PORT}}:9999 \
              --name ${{secrets.SERVER_DOCKER_CONATINER_NAME}} \
              --restart always \
              --env-file .env \
              ${{secrets.DOCKER_IMAGE_NAME_WITH_TAG}}

            echo "âœ… ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"

            docker logs ${{secrets.SERVER_DOCKER_CONATINER_NAME}} --timestamps --tail 100

            echo "=============================="
            echo "ğŸ‰ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
            echo "=============================="
