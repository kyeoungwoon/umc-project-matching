###
# UMC 프로젝트 매칭 시스템 - 회원가입/로그인 플로우 테스트
#
# ⚠️ 중요: 이 파일의 모든 요청은 순차적으로 실행되어야 합니다.
#
# 실행 방법:
# 1. 첫 번째 요청부터 순서대로 하나씩 실행 (각 요청 옆의 ▶️ 버튼 클릭)
# 2. 또는 "Run All Requests in File" 사용
#
# 각 요청은 이전 요청의 응답에서 받은 데이터(accessToken, userId 등)를 사용합니다.
# client.global.set()으로 저장된 변수들은 {{variable}} 형태로 다음 요청에서 사용됩니다.
###

@baseUrl = http://localhost:9999
@school = 중앙대학교
@studentId = 20240001
@name = 테스트유저
@nickname = 테스터
@password = testPassword123!
@part = WEB
@newPassword = newPassword456!

### 1. 회원가입을 한다
POST {{baseUrl}}/v1/auth/register
Content-Type: application/json

{
  "name": "{{name}}",
  "nickname": "{{nickname}}",
  "school": "{{school}}",
  "studentId": "{{studentId}}",
  "password": "{{password}}",
  "part": "{{part}}"
}

> {%
    client.test("회원가입 성공", function () {
        client.assert(response.status === 201 || response.status === 200, "응답 상태 코드는 200 또는 201이어야 합니다");
    });
%}

### 2. 중복된 학교와 학번으로 회원가입을 다시 시도한다
POST {{baseUrl}}/v1/auth/register
Content-Type: application/json

{
  "name": "중복유저",
  "nickname": "중복",
  "school": "{{school}}",
  "studentId": "{{studentId}}",
  "password": "{{password}}",
  "part": "{{part}}"
}

> {%
    client.test("중복 회원가입 실패", function () {
        client.assert(response.status === 400 || response.status === 409, "응답 상태 코드는 400 또는 409이어야 합니다");
    });
%}

### 3. 로그인을 한다
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "school": "{{school}}",
  "studentId": "{{studentId}}",
  "password": "{{password}}"
}

> {%
    client.test("로그인 성공", function () {
        client.assert(response.status === 200 || response.status === 201, "응답 상태 코드는 200 또는 201이어야 합니다");
        client.assert(response.body.result.hasOwnProperty("accessToken"), "accessToken이 응답에 포함되어야 합니다");
        client.global.set("accessToken", response.body.result.accessToken);
    });
%}

### 4. 내 정보 조회를 한다
GET {{baseUrl}}/v1/users/me
Authorization: Bearer {{accessToken}}

> {%
    client.test("내 정보 조회 성공", function () {
        client.assert(response.status === 200, "응답 상태 코드는 200이어야 합니다");
        client.assert(response.body.result, "응답에 result가 포함되어야 합니다");
        client.assert(response.body.result.studentId === "{{studentId}}", "학번이 일치해야 합니다");
        // userId 저장 (회원 탈퇴에 사용)
        if (response.body.result.id) {
            client.global.set("userId", response.body.result.id);
        }
    });
%}

### 5. 비밀번호 변경을 한다
POST {{baseUrl}}/v1/auth/change-password
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "currentPassword": "{{password}}",
  "newPassword": "{{newPassword}}"
}

> {%
    client.test("비밀번호 변경 성공", function () {
        client.assert(response.status === 200 || response.status === 201, "응답 상태 코드는 200 또는 201이어야 합니다");
    });
%}

### 6. 변경된 비밀번호로 로그인을 한다
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "school": "{{school}}",
  "studentId": "{{studentId}}",
  "password": "{{newPassword}}"
}

> {%
    client.test("새 비밀번호로 로그인 성공", function () {
        client.assert(response.status === 200 || response.status === 201, "응답 상태 코드는 200 또는 201이어야 합니다");
        client.assert(response.body.result.hasOwnProperty("accessToken"), "accessToken이 응답에 포함되어야 합니다");
        client.global.set("accessToken", response.body.result.accessToken);
    });
%}

### 7. 회원 탈퇴를 한다
DELETE {{baseUrl}}/v1/auth/deactivate/{{userId}}
Authorization: Bearer {{accessToken}}

> {%
    client.test("회원 탈퇴 성공", function () {
        client.assert(response.status === 200 || response.status === 204, "응답 상태 코드는 200 또는 204이어야 합니다");
    });
%}
